services:
  traefik:
    image: traefik:latest
    container_name: traefik
    ports:
      - "127.0.0.1:${DASHBOARD_PORT}:8080"
      - "127.0.0.1:${HTTP_PORT}:80"
      - "127.0.0.1:${HTTPS_PORT}:443"
      - "${HTTPS_PORT}:443/udp"
      - "127.0.0.1:8048:8048"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DOCKER_API_VERSION=1.45
      - DOCKER_CLIENT_API_VERSION=1.45
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik-net"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http3"
      - "--entrypoints.federation.address=:8048"
    networks:
      traefik-net:
        aliases:
          - ${DOMAIN_LIVEKIT}

  element-web:
    image: vectorim/element-web:${ELEMENT_VERSION}
    container_name: element-web
    restart: unless-stopped
    volumes:
      - ./config.json:/app/config.json
      - ./.well-known:/app/.well-known
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.element-router.rule=Host(`${DOMAIN_ELEMENT}`)"
      - "traefik.http.routers.element-router.entrypoints=web"
      - "traefik.http.routers.element-router.service=element-service"
      - "traefik.http.routers.element-router-secure.rule=Host(`${DOMAIN_ELEMENT}`)"
      - "traefik.http.routers.element-router-secure.entrypoints=websecure"
      - "traefik.http.routers.element-router-secure.tls=false"
      # well-known delegation for Federation
      - "traefik.http.routers.well-known.rule=Host(`${DOMAIN_MATRIX}`) && PathPrefix(`/.well-known/matrix`)"
      - "traefik.http.routers.well-known.entrypoints=web,websecure"
      - "traefik.http.routers.well-known.service=element-service"
      - "traefik.http.routers.well-known.tls=false"
      - "traefik.http.routers.well-known.middlewares=cors-headers@docker"
      # CORS Middleware for client well-known files
      - "traefik.http.middlewares.cors-headers.headers.accesscontrolallowmethods=GET,OPTIONS"
      - "traefik.http.middlewares.cors-headers.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.cors-headers.headers.accesscontrolallowheaders=Content-Type,Authorization"
      - "traefik.http.middlewares.cors-headers.headers.accesscontrolmaxage=86400"
      - "traefik.http.services.element-service.loadbalancer.server.port=80"
    networks:
      - traefik-net

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    restart: unless-stopped
    volumes:
      - ./synapse-data:/data
    environment:
      - SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME}
      - SYNAPSE_REPORT_STATS=${SYNAPSE_REPORT_STATS}
      - SYNAPSE_CONFIG_DIR=/data
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      - db
      - coturn
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.matrix-router.rule=Host(`${DOMAIN_MATRIX}`)"
      - "traefik.http.routers.matrix-router.entrypoints=web"
      - "traefik.http.routers.matrix-router.service=matrix-service"
      - "traefik.http.routers.matrix-router-secure.rule=Host(`${DOMAIN_MATRIX}`)"
      - "traefik.http.routers.matrix-router-secure.entrypoints=websecure"
      - "traefik.http.routers.matrix-router-secure.tls=false"
      - "traefik.http.routers.matrix-federation.rule=Host(`${DOMAIN_MATRIX}`)"
      - "traefik.http.routers.matrix-federation.entrypoints=federation"
      - "traefik.http.routers.matrix-federation.tls=false"
      - "traefik.http.services.matrix-service.loadbalancer.server.port=8008"
    networks:
      - traefik-net

  db:
    image: postgres:15-alpine
    container_name: synapse_db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - traefik-net

  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    network_mode: host
    restart: unless-stopped
    command:
      - -n
      - --min-port=49152
      - --max-port=49162
      - --realm=${TURN_REALM}
      - --use-auth-secret
      - --static-auth-secret=${TURN_SECRET}
      - --external-ip=${EXTERNAL_IP}

networks:
  traefik-net:
    driver: bridge

volumes:
  db_data:
